<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- 視口設定：禁止縮放，適配手機 App 模式 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>線上輔助唸珠 | 線上玫瑰經祈禱團體</title>
    
    <!-- PWA / Web App 設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="線上唸珠">
    <meta name="theme-color" content="#003366">
    
    <!-- App 圖示佔位符 (稍後由 JS 替換為 PNG) -->
    <link rel="icon" id="favicon" sizes="192x192" href="">
    <link rel="apple-touch-icon" id="apple-icon" href="">

    <!-- 引入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- 引入 Font Awesome 圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 繼承全域變數 --- */
        :root {
            --primary-color: #003366; 
            --secondary-color: #4A90E2; 
            --accent-color: #D4AF37; 
            --bg-color: #F5F7FA;
            --section-bg: #FFFFFF;
            --border-color: #DAE1E7;
            --text-color: #2C3E50; 
            --light-text: #5D6D7E; 
            --white: #ffffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            color: var(--text-color);
            background-color: var(--bg-color);
            background-image: radial-gradient(#4A90E2 0.5px, transparent 0.5px), radial-gradient(#4A90E2 0.5px, #F5F7FA 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            background-attachment: fixed;
            line-height: 1.5;
            height: 100dvh; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        h1, h2, h3, h4 {
            font-family: 'Noto Serif TC', serif;
            color: var(--primary-color);
            letter-spacing: 0.05em;
        }

        a { text-decoration: none; color: inherit; }

        /* --- 導覽列 --- */
        header {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 51, 102, 0.1);
            position: fixed;
            width: 100%;
            top: 0;
            padding-top: env(safe-area-inset-top);
            z-index: 1000;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            height: calc(60px + env(safe-area-inset-top)); /* 稍微縮小 header */
            display: flex;
            flex-direction: column;
        }
        
        .header-top-bar {
            height: 4px; /* 稍微變細 */
            flex-shrink: 0;
            background: repeating-linear-gradient(
                90deg,
                var(--primary-color),
                var(--primary-color) 20px,
                var(--secondary-color) 20px,
                var(--secondary-color) 40px,
                var(--accent-color) 40px,
                var(--accent-color) 45px,
                var(--white) 45px,
                var(--white) 50px
            );
        }

        nav {
            max-width: 1100px;
            width: 100%;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
        }

        .logo {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon-box {
            width: 32px;
            height: 32px;
            background-color: var(--primary-color);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50% 50% 0 50%;
            box-shadow: 2px 2px 0px var(--accent-color);
        }

        .logo-icon-box i { font-size: 0.9rem; margin-top: 2px; color: var(--white); }
        .logo-text { display: flex; flex-direction: column; line-height: 1.1; }
        .logo small { font-size: 0.65rem; font-weight: 400; color: var(--secondary-color); }

        .nav-links { display: flex; gap: 1rem; align-items: center; }
        .nav-links a { font-weight: 600; font-size: 0.9rem; transition: color 0.3s; color: var(--text-color); position: relative; }
        .nav-links a:hover { color: var(--secondary-color); }

        .cta-button-small {
            background-color: var(--secondary-color);
            color: var(--white) !important;
            padding: 0.4rem 1rem;
            font-size: 0.85rem;
            transition: all 0.3s;
            border-radius: 50px;
            box-shadow: 0 4px 6px rgba(74, 144, 226, 0.3);
        }
        .cta-button-small:hover { 
            background-color: var(--primary-color); 
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 51, 102, 0.3);
        }

        .mobile-menu-btn { display: none; font-size: 1.4rem; cursor: pointer; color: var(--primary-color); }

        /* --- 主要內容區塊 --- */
        #rosary-app {
            flex-grow: 1;
            margin-top: calc(60px + env(safe-area-inset-top));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-evenly;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding: 10px;
            overflow: hidden;
        }

        /* 奧蹟標題卡 */
        .mystery-header {
            text-align: center;
            flex-shrink: 0;
            z-index: 5;
            margin-bottom: 5px;
        }
        .mystery-header h2 { 
            font-size: 1.2rem; 
            margin-bottom: 0px; 
            color: var(--primary-color);
            text-shadow: 0 2px 10px rgba(255,255,255,0.8);
        }
        .mystery-header p { 
            color: var(--light-text); 
            font-size: 0.85rem; 
            background: rgba(255,255,255,0.6);
            padding: 1px 10px;
            border-radius: 20px;
        }

        /* --- 擬真念珠設計 (再縮小) --- */
        .beads-container {
            position: relative;
            width: 42vmin; /* 縮小 */
            height: 42vmin;
            max-width: 320px;
            max-height: 320px;
            margin: 5px 0;
            border-radius: 50%;
        }
        
        .chain-svg {
            position: absolute;
            top: -5%; left: -5%;
            width: 110%; height: 110%;
            pointer-events: none;
            opacity: 0.8;
        }

        /* 珠子通用樣式 - 再縮小 */
        .bead {
            position: absolute;
            width: 14px; /* 縮小 */
            height: 14px; /* 縮小 */
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 2;
            background: radial-gradient(circle at 35% 35%, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(74, 144, 226, 0.8) 20%, 
                rgba(0, 51, 102, 1) 80%, 
                rgba(0, 20, 40, 1) 100%);
            box-shadow: 
                inset -1px -1px 3px rgba(0,0,0,0.4),
                1px 2px 4px rgba(0,0,0,0.3);
        }

        /* 大珠 - 再縮小 */
        .bead[data-type="large"] {
            width: 18px; /* 縮小 */
            height: 18px; /* 縮小 */
            background: radial-gradient(circle at 30% 30%, #fffbe6, #D4AF37, #b8860b);
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 
                inset -2px -2px 6px rgba(0,0,0,0.5),
                0 0 0 1px rgba(184, 134, 11, 0.3),
                2px 3px 6px rgba(0,0,0,0.4);
        }
        
        /* 十字架 - 再縮小 */
        .bead[data-type="cross"] {
            width: 20px; height: 28px; /* 縮小 */
            border-radius: 2px;
            background: linear-gradient(135deg, #f5f5f5 0%, #dcdcdc 50%, #999 100%);
            clip-path: polygon(35% 0%, 65% 0%, 65% 30%, 100% 30%, 100% 50%, 65% 50%, 65% 100%, 35% 100%, 35% 50%, 0% 50%, 0% 30%, 35% 30%);
            box-shadow: none;
            filter: drop-shadow(1px 2px 2px rgba(0,0,0,0.5));
        }

        /* 激活狀態 */
        .bead.active {
            transform: translate(-50%, -50%) scale(1.6); /* 稍微放大倍率以凸顯 */
            box-shadow: 
                0 0 12px var(--accent-color), 
                0 0 25px var(--secondary-color),
                inset -2px -2px 6px rgba(0,0,0,0.4);
            filter: brightness(1.2);
            z-index: 100;
        }
        
        /* 中心聖母牌 - 再縮小 */
        .center-medal {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 45px; height: 55px; /* 縮小 */
            background: radial-gradient(ellipse at center, #fff, #e0e0e0);
            border: 2px solid var(--accent-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem; /* 縮小 */
            color: var(--primary-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2), inset 0 0 10px rgba(0,0,0,0.1);
            z-index: 1;
        }

        /* 經文顯示卡片 */
        .prayer-display {
            background-color: var(--white);
            width: 95%;
            max-width: 500px;
            padding: 1rem;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-bottom: 4px solid var(--primary-color);
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 22vh; /* 縮小 */
            max-height: 35vh;
            flex-shrink: 1;
            overflow-y: auto;
        }
        
        .prayer-display:active {
            background-color: #f8fafc;
            transform: scale(0.99);
        }

        .prayer-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.3rem;
            flex-shrink: 0;
        }
        
        .prayer-text {
            font-size: 1rem;
            color: #444;
            line-height: 1.5;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: pre-wrap;
            transition: font-size 0.2s;
        }

        .progress-indicator {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--light-text);
            background: #eee;
            padding: 2px 10px;
            border-radius: 20px;
            align-self: center;
            flex-shrink: 0;
        }

        .tap-hint {
            font-size: 0.7rem;
            color: #aaa;
            margin-top: 3px;
            flex-shrink: 0;
        }

        .font-controls {
            position: absolute;
            top: 5px; right: 5px;
            display: flex; gap: 5px;
            z-index: 20;
        }
        
        .font-btn {
            background-color: rgba(0,0,0,0.05);
            border: none; width: 28px; height: 28px; border-radius: 50%;
            color: var(--primary-color); font-weight: bold; font-size: 0.8rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .font-btn:hover { background-color: var(--secondary-color); color: white; }

        .controls {
            display: flex; gap: 20px; margin-bottom: 5px; flex-shrink: 0;
        }

        .control-btn {
            background-color: var(--white);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; cursor: pointer; transition: all 0.2s;
        }
        .control-btn:active { background-color: var(--primary-color); color: var(--white); }

        .toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.7); color: white;
            padding: 8px 16px; border-radius: 20px; font-size: 0.9rem;
            opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 2000;
        }
        .toast.show { opacity: 1; }

        footer {
            background-color: var(--primary-color); color: var(--white); 
            padding: 0.3rem; text-align: center;
            border-top: 2px solid var(--accent-color);
            font-size: 0.7rem; flex-shrink: 0; height: auto;
            padding-bottom: calc(0.3rem + env(safe-area-inset-bottom));
        }
        footer p { margin: 2px 0; opacity: 0.8; }
        .social-links { display: none; }

        @media (min-height: 800px) {
            .social-links { display: block; margin: 5px 0; }
            .social-links a { margin: 0 5px; color: var(--accent-color); font-size: 1rem; }
            footer { padding: 0.8rem; padding-bottom: calc(0.8rem + env(safe-area-inset-bottom)); }
        }

        @media (max-width: 768px) {
            .nav-links { display: none; position: absolute; top: 100%; left: 0; width: 100%; background-color: var(--section-bg); flex-direction: column; padding: 1.5rem; box-shadow: 0 10px 15px rgba(0,0,0,0.1); border-bottom: 5px solid var(--secondary-color); }
            .nav-links.active { display: flex; }
            .nav-links a { margin: 10px 0; width: 100%; text-align: center; }
            .mobile-menu-btn { display: block; }
            
            .beads-container { width: 50vmin; height: 50vmin; }
            .prayer-display { width: 90%; min-height: 20vh; }
            .prayer-text { font-size: 1rem; }
        }
        
        /* 隱藏的 Canvas 用於生成 Icon */
        #icon-canvas { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="header-top-bar"></div>
        <nav>
            <div class="logo">
                <div class="logo-icon-box"><i class="fa-solid fa-dove"></i></div>
                <div class="logo-text">
                    <span>線上玫瑰經祈禱</span>
                    <small>每晚9點 LINE會議室</small>
                </div>
            </div>
            <div class="nav-links">
                <a href="index.html">回到首頁</a>
                <a href="index.html#about">關於我們</a>
                <a href="index.html#info">聚會資訊</a>
                <a href="rosary.html" style="color: var(--secondary-color);"><i class="fa-solid fa-xs fa-bullseye"></i> 線上唸珠</a>
                <a href="intercession.html">代禱牆</a>
                <a href="https://line.me/R/meeting/6e1105b1919945ddad5390853d75be5d" target="_blank" class="cta-button-small">進入會議室</a>
            </div>
            <div class="mobile-menu-btn"><i class="fa-solid fa-bars"></i></div>
        </nav>
    </header>

    <div id="rosary-app">
        
        <div class="mystery-header">
            <h2 id="current-mystery-title">準備祈禱</h2>
            <p id="current-mystery-desc">請懷著虔敬的心</p>
        </div>

        <div class="beads-container" id="beads-ring">
            <svg class="chain-svg" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="48" fill="none" stroke="rgba(0,0,0,0.15)" stroke-width="2" />
                <circle cx="50" cy="50" r="48" fill="none" stroke="#B0B0B0" stroke-width="1" stroke-dasharray="0.5, 2.5" stroke-linecap="round" />
            </svg>
            
            <div class="center-medal">
                <i class="fa-solid fa-hands-praying"></i>
            </div>
        </div>

        <div class="prayer-display" id="prayer-card" onclick="nextBead()">
            <div class="font-controls" onclick="event.stopPropagation()">
                <button class="font-btn" onclick="adjustFontSize(-1)" title="縮小字體"><i class="fa-solid fa-minus"></i></button>
                <button class="font-btn" onclick="adjustFontSize(1)" title="放大字體"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div class="prayer-title" id="prayer-name">聖號經</div>
            <div class="prayer-text" id="prayer-content">因父、及子、及聖神之名。<br>阿們。</div>
            <div class="progress-indicator" id="progress-text">開始</div>
            <div class="tap-hint"><i class="fa-solid fa-hand-pointer"></i> 點擊卡片撥動下一顆</div>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="prevBead()" title="上一顆"><i class="fa-solid fa-arrow-left"></i></button>
            <button class="control-btn" onclick="resetRosary()" title="重新開始"><i class="fa-solid fa-rotate-left"></i></button>
        </div>

    </div>

    <div id="toast" class="toast">已恢復上次進度</div>
    
    <!-- 隱藏 Canvas 用於生成 Icon -->
    <canvas id="icon-canvas" width="512" height="512"></canvas>

    <footer>
        <div class="social-links">
            <a href="#"><i class="fa-brands fa-facebook"></i></a>
            <a href="#"><i class="fa-brands fa-line"></i></a>
        </div>
        <p>© 2025 Online Rosary Group.</p>
    </footer>

    <script>
        const prayers = {
            signOfCross: { title: "聖號經", content: "因父、及子、及聖神之名。阿們。" },
            creed: { title: "信經", content: "我信全能的天主父，天地萬物的創造者。我信父的唯一子，我們的主耶穌基督..." },
            ourFather: { title: "天主經", content: "我們的天父，願你的名受顯揚，願你的國來臨，願你的旨意奉行在人間，如同在天上..." },
            hailMary: { title: "聖母經", content: "萬福瑪利亞，妳充滿聖寵，主與妳同在。妳在婦女中受讚頌，妳的親子耶穌同受讚頌..." },
            gloryBe: { title: "聖三光榮經", content: "願光榮歸於父、及子、及聖神。起初如何，今日亦然，直到永遠。阿們。" },
            fatima: { title: "法蒂瑪聖母禱詞", content: "吾主耶穌，請寬赦我們的罪過，助我們免於地獄永火。求祢把眾人的靈魂，特別是那些最需要祢憐憫的靈魂，領到天國裡去。" },
            hailHolyQueen: { title: "又聖母經", content: "萬福母后！仁慈的母親，我們的生命，我們的甘飴，我們的希望..." }
        };

        const mysteries = {
            joyful: [
                { title: "歡喜一端", desc: "天使向聖母瑪利亞報喜" },
                { title: "歡喜二端", desc: "聖母拜訪聖婦依撒伯爾" },
                { title: "歡喜三端", desc: "耶穌誕生於白冷" },
                { title: "歡喜四端", desc: "聖母獻耶穌於聖殿" },
                { title: "歡喜五端", desc: "耶穌十二歲講道" }
            ],
            luminous: [
                { title: "光明一端", desc: "耶穌在約旦河受洗" },
                { title: "光明二端", desc: "耶穌參加加納婚宴" },
                { title: "光明三端", desc: "耶穌宣講天國福音" },
                { title: "光明四端", desc: "耶穌顯聖容" },
                { title: "光明五端", desc: "耶穌建立聖體聖事" }
            ],
            sorrowful: [
                { title: "痛苦一端", desc: "耶穌山園祈禱" },
                { title: "痛苦二端", desc: "耶穌受鞭打之刑" },
                { title: "痛苦三端", desc: "耶穌受茨冠之苦刑" },
                { title: "痛苦四端", desc: "耶穌背十字架上山" },
                { title: "痛苦五端", desc: "耶穌被釘死在十字架上" }
            ],
            glorious: [
                { title: "榮福一端", desc: "耶穌復活" },
                { title: "榮福二端", desc: "耶穌升天" },
                { title: "榮福三端", desc: "聖神降臨" },
                { title: "榮福四端", desc: "聖母蒙召升天" },
                { title: "榮福五端", desc: "天主光榮聖母" }
            ]
        };

        let rosarySequence = [];
        let currentIndex = 0;
        let todayMysteries = [];
        let currentFontSize = 1.05;

        function initMystery() {
            const day = new Date().getDay();
            if (day === 1 || day === 6) todayMysteries = mysteries.joyful;
            else if (day === 2 || day === 5) todayMysteries = mysteries.sorrowful;
            else if (day === 4) todayMysteries = mysteries.luminous;
            else todayMysteries = mysteries.glorious;
        }

        function buildSequence() {
            rosarySequence = [];
            rosarySequence.push({ key: 'signOfCross', step: '開始', beadId: 'bead-cross', mysteryIdx: -1 });
            rosarySequence.push({ key: 'creed', step: '信經', beadId: 'bead-cross', mysteryIdx: -1 });
            rosarySequence.push({ key: 'ourFather', step: '為教宗祈禱', beadId: 'bead-start-large', mysteryIdx: -1 });
            for(let i=1; i<=3; i++) {
                rosarySequence.push({ key: 'hailMary', step: `信望愛 ${i}/3`, beadId: `bead-start-${i}`, mysteryIdx: -1 });
            }
            rosarySequence.push({ key: 'gloryBe', step: '光榮經', beadId: 'bead-gap', mysteryIdx: -1 });

            for (let m = 0; m < 5; m++) {
                const mNum = ["一", "二", "三", "四", "五"][m];
                rosarySequence.push({ key: 'mystery', mysteryIdx: m, step: `第${mNum}端奧蹟`, beadId: 'bead-large', isLarge: true });
                rosarySequence.push({ key: 'ourFather', step: `第${mNum}端`, beadId: 'bead-large', mysteryIdx: m, isLarge: true });
                for(let i=1; i<=10; i++) {
                    rosarySequence.push({ key: 'hailMary', step: `聖母經 ${i}/10`, beadId: `bead-${i}`, mysteryIdx: m });
                }
                rosarySequence.push({ key: 'gloryBe', step: `第${mNum}端結束`, beadId: 'bead-gap', mysteryIdx: m });
                rosarySequence.push({ key: 'fatima', step: '法蒂瑪禱詞', beadId: 'bead-gap', mysteryIdx: m });
            }
            
            rosarySequence.push({ key: 'hailHolyQueen', step: '結束禱詞', beadId: 'center-medal', mysteryIdx: -1 });
            rosarySequence.push({ key: 'signOfCross', step: '禮成', beadId: 'bead-cross', mysteryIdx: -1 });
        }

        function renderBeads() {
            const container = document.getElementById('beads-ring');
            const existingBeads = container.querySelectorAll('.bead');
            existingBeads.forEach(b => b.remove());
            
            const radius = 48;
            const total = 11;
            
            for (let i = 1; i <= 10; i++) {
                const angleDeg = -90 + (i * (360 / total));
                createBead(container, radius, angleDeg, `bead-${i}`, 'small');
            }
            createBead(container, radius, -90, 'bead-large', 'large');
            createBead(container, 25, 90, 'bead-start-1', 'small');
            createBead(container, 15, 90, 'bead-start-2', 'small');
            createBead(container, 5, 90, 'bead-start-3', 'small');
            createBead(container, 50, 180, 'bead-cross', 'cross'); 
        }
        
        function createBead(container, rPercent, angleDeg, id, type) {
            const bead = document.createElement('div');
            bead.className = 'bead';
            bead.id = id;
            bead.dataset.type = type;
            
            if (type === 'cross') {
                bead.style.left = '50%';
                bead.style.top = '105%'; 
            } else {
                const x = 50 + rPercent * Math.cos(angleDeg * Math.PI / 180);
                const y = 50 + rPercent * Math.sin(angleDeg * Math.PI / 180);
                bead.style.left = `${x}%`;
                bead.style.top = `${y}%`;
            }
            container.appendChild(bead);
        }

        function adjustFontSize(delta) {
            currentFontSize += (delta * 0.1);
            if (currentFontSize < 0.8) currentFontSize = 0.8;
            if (currentFontSize > 1.8) currentFontSize = 1.8;
            document.getElementById('prayer-content').style.fontSize = `${currentFontSize}rem`;
        }

        function saveProgress() {
            localStorage.setItem('rosaryProgressIndex', currentIndex);
            localStorage.setItem('rosaryLastDate', new Date().toDateString());
        }

        function loadProgress() {
            const savedIndex = localStorage.getItem('rosaryProgressIndex');
            const savedDate = localStorage.getItem('rosaryLastDate');
            const today = new Date().toDateString();

            if (savedIndex && savedDate === today) {
                currentIndex = parseInt(savedIndex);
                if (currentIndex > 0) {
                    showToast("已恢復上次進度");
                }
            } else {
                currentIndex = 0;
                localStorage.removeItem('rosaryProgressIndex');
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function updateDisplay() {
            const currentStep = rosarySequence[currentIndex];
            const titleEl = document.getElementById('prayer-name');
            const contentEl = document.getElementById('prayer-content');
            const progressEl = document.getElementById('progress-text');
            const mysteryTitle = document.getElementById('current-mystery-title');
            const mysteryDesc = document.getElementById('current-mystery-desc');
            
            if (currentStep.mysteryIdx !== undefined && currentStep.mysteryIdx >= 0) {
                const currentM = todayMysteries[currentStep.mysteryIdx]; 
                mysteryTitle.innerText = currentM.title;
                mysteryDesc.innerText = currentM.desc;
            } else if (currentIndex < 5) {
                mysteryTitle.innerText = "準備祈禱";
                mysteryDesc.innerText = "請懷著虔敬的心";
            } else {
                mysteryTitle.innerText = "結束禱詞";
                mysteryDesc.innerText = "感謝天主垂聽";
            }

            if (currentStep.key === 'mystery') {
                const currentM = todayMysteries[currentStep.mysteryIdx];
                titleEl.innerText = currentM.title;
                contentEl.innerText = currentM.desc + "\n(請默想此奧蹟)";
            } else {
                titleEl.innerText = prayers[currentStep.key].title;
                contentEl.innerText = prayers[currentStep.key].content;
            }
            
            progressEl.innerText = currentStep.step;

            document.querySelectorAll('.bead').forEach(b => b.classList.remove('active'));
            if (currentStep.beadId) {
                const targetBead = document.getElementById(currentStep.beadId);
                if (targetBead) targetBead.classList.add('active');
            }
        }

        function nextBead() {
            if (currentIndex < rosarySequence.length - 1) {
                currentIndex++;
                updateDisplay();
                saveProgress();
                if (navigator.vibrate) navigator.vibrate(10); 
            } else {
                alert("祈禱結束，感謝天主！");
                currentIndex = 0;
                updateDisplay();
                saveProgress();
            }
        }

        function prevBead() {
            if (currentIndex > 0) {
                currentIndex--;
                updateDisplay();
                saveProgress();
            }
        }

        function resetRosary() {
            if(confirm("確定要重新開始嗎？")) {
                currentIndex = 0;
                updateDisplay();
                saveProgress();
            }
        }

        // --- 核心功能：動態生成 iOS 圖示 ---
        function generateAppIcon() {
            const canvas = document.getElementById('icon-canvas');
            const ctx = canvas.getContext('2d');
            const size = canvas.width;
            
            // 1. 繪製背景 (圓角矩形，雖然 iOS 會自動裁切，但我們畫個底)
            ctx.fillStyle = "#003366";
            ctx.fillRect(0, 0, size, size);
            
            // 2. 繪製鴿子 (簡化版 SVG Path)
            ctx.fillStyle = "#ffffff";
            const p = new Path2D("M256 160c15 0 28.5 7.4 36.8 20.1C301.7 192.1 316.3 200 332.3 200h2.9c19.3 0 35.8-14.1 39.2-33.1l8.3-46.7c4.6-26.1-15.6-49.6-41.5-49.6h-3.6c-12.7 0-23.7-8.1-27.1-20.3-6.2-22.3-26.6-38.3-50.5-38.3H256c-28.7 0-52 23.3-52 52v44c0 28.7 23.3 52 52 52z");
            
            // 移動與縮放以置中
            ctx.save();
            ctx.translate(20, 50); // 微調位置
            ctx.scale(1.2, 1.2);   // 放大
            ctx.fill(p);
            ctx.restore();
            
            // 3. 輸出為 PNG Data URL 並設定給 link tags
            const dataUrl = canvas.toDataURL('image/png');
            document.getElementById('favicon').href = dataUrl;
            document.getElementById('apple-icon').href = dataUrl;
        }

        window.onload = function() {
            // 生成圖示
            generateAppIcon();
            
            initMystery();
            buildSequence();
            loadProgress();
            renderBeads();
            updateDisplay();
            
            const mobileBtn = document.querySelector('.mobile-menu-btn');
            const navLinks = document.querySelector('.nav-links');
            if(mobileBtn) {
                mobileBtn.addEventListener('click', () => { 
                    navLinks.classList.toggle('active'); 
                });
            }
        };
    </script>
</body>
</html>
